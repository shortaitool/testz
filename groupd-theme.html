<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
<title>Beautiful Test Theme — Mobile-First</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
/* -------------------- CSS RESET & TOKENS -------------------- */
:root{
  --bg: #0b0f1a;
  --bg-2:#0e1422;
  --card:#0f172acc; /* glass */
  --border:#1f2a3d;
  --muted:#9ca3af;
  --text:#e5e7eb;
  --primary:#60a5fa;   /* blue */
  --accent:#22c55e;    /* green */
  --danger:#ef4444;    /* red */
  --warn:#f59e0b;      /* amber */
  --chip:#111827;
  --shadow: 0 8px 26px rgba(0,0,0,.35);
  --radius: 18px;
  --touch: 48px; /* comfortable touch target */
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  background: radial-gradient(120% 100% at 10% 0%, #0e1422 0%, #0b0f1a 50%, #080c16 100%);
  color:var(--text);
  /* prevent layout jump on mobile address bar */
  min-height: var(--dvh, 100dvh);
}

/* Layout: sticky header + sticky qnav + scrollable main + fixed bottom bar */
.app{ display:flex; flex-direction:column; min-height: var(--dvh, 100dvh); max-height: var(--dvh, 100dvh); overflow:hidden; }

/* -------------------- HEADER -------------------- */
header{
  position:sticky; top:0; z-index:20; backdrop-filter: blur(14px);
  background: linear-gradient(180deg, #0c1220f2, #0b0f1ad8);
  border-bottom:1px solid var(--border);
}
.header-row{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:12px 12px; }
.brand{ display:flex; align-items:center; gap:12px; min-width:0; }
.logo{ width:40px; height:40px; border-radius:12px; background:conic-gradient(from 180deg,#22c55e,#60a5fa,#a78bfa,#22c55e); box-shadow:0 0 0 3px #101827 inset, 0 6px 18px rgba(0,0,0,.45); }
.title{ font-size: clamp(16px, 2.6vw, 20px); margin:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

.timer{ font-weight:800; padding:10px 14px; border-radius:999px; letter-spacing:.4px; min-width:124px; text-align:center; background:#0b1424; border:1px solid var(--border); transition: transform .18s ease, box-shadow .2s ease; }
.timer.warn{ background:#3a1212; color:#fff; box-shadow:0 0 0 2px #7f1d1d inset, 0 0 22px #7f1d1d66; animation:pulse 1s infinite; }
@keyframes pulse{ 0%{transform:scale(1)} 50%{transform:scale(1.03)} 100%{transform:scale(1)} }

.stats{ display:flex; gap:10px; flex-wrap:wrap; }
.chip{ display:flex; align-items:center; gap:8px; padding:8px 12px; border-radius:12px; border:1px solid var(--border); background:linear-gradient(180deg,#0d1426e6,#0b0f1ae6); box-shadow:var(--shadow); font-size:14px; }
.dot{ width:10px; height:10px; border-radius:50% }
.dot-g{ background:var(--accent) }
.dot-r{ background:var(--danger) }

/* -------------------- QUESTION NAV (HORIZONTAL) -------------------- */
.qnav-wrap{ position:sticky; top:64px; z-index:18; background:#0b0f1ad1; backdrop-filter: blur(10px); border-bottom:1px solid var(--border); padding:8px 8px; }
.qnav{ display:flex; gap:8px; overflow-x:auto; overscroll-behavior-x:contain; scroll-snap-type:x proximity; padding-bottom:6px; }
.qnum{ flex:0 0 auto; width:38px; height:38px; border-radius:13px; display:flex; align-items:center; justify-content:center; font-weight:800; letter-spacing:.3px; cursor:pointer; user-select:none; scroll-snap-align:center; color:#dbeafe; background:var(--chip); border:2px solid #233047; transition: transform .12s ease, background .15s ease, border-color .15s ease; }
.qnum.current{ outline:2px solid var(--primary); outline-offset:2px; transform:scale(1.05) }
.qnum.answered{ background:#0c2915; border-color:#14532d; color:#86efac }
.qnum.unanswered{ background:#2a0e0e; border-color:#7f1d1d; color:#fca5a5 }

/* -------------------- MAIN (Scrollable) -------------------- */
.main{ flex:1; min-height:0; overflow:auto; padding:12px 12px calc(110px + env(safe-area-inset-bottom)) 12px; }
.card{ background:linear-gradient(180deg,#0c1220f2,#0b0f1ae8); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); display:flex; flex-direction:column; min-height: min(680px, 65vh); }

.qhead{ display:flex; gap:10px; align-items:flex-start; border-bottom:1px dashed #263244; padding:14px; }
.badge{ font-weight:900; color:#93c5fd; background:#0b2544; border:1px solid #1e3a8a; padding:6px 10px; border-radius:10px; }
.qtext{ margin:0; font-size: clamp(15px, 2.6vw, 17px); line-height:1.55; color:#e5e7eb; max-height:7.5lh; overflow:auto; padding-right:6px; }

.qbody{ padding:12px 14px 16px 14px; display:flex; flex-direction:column; gap:10px; min-height:0; }
.opt{ position:relative; border:2px solid #223047; padding:12px; border-radius:14px; background:#0b1526; display:flex; gap:10px; align-items:flex-start; cursor:pointer; overflow:hidden; transition: transform .1s ease, border-color .15s ease, background .15s ease, box-shadow .15s ease; min-height: var(--touch); }
.opt:hover{ transform:translateY(-1px) }
.opt.selected{ background:linear-gradient(180deg,#052e1a,#0e2f20); border-color:#14532d; box-shadow:0 0 0 2px #14532d inset; }
.tag{ min-width:28px; height:28px; border-radius:8px; display:flex; align-items:center; justify-content:center; background:#0b1426; border:1px solid #223046; color:#93c5fd; font-weight:800; margin-top:2px; }
.opt-label{ flex:1; color:#dbeafe; }

/* -------------------- BOTTOM NAV (Fixed + Safe Area) -------------------- */
.bottom{ position:fixed; left:0; right:0; bottom:0; z-index:30; display:flex; gap:10px; padding:10px 10px calc(10px + env(safe-area-inset-bottom)) 10px; background:linear-gradient(180deg,#0b0f1ad9,#000000ef); border-top:1px solid var(--border); backdrop-filter: blur(10px); }
.btn{ flex:1; min-height:var(--touch); border-radius:14px; border:2px solid #2b3546; color:#e5e7eb; background:linear-gradient(180deg,#0f172a,#0b1220); font-weight:900; letter-spacing:.3px; position:relative; overflow:hidden; cursor:pointer; transition: transform .1s ease, border-color .2s ease, box-shadow .2s ease, background .2s ease; }
.btn:hover{ transform:translateY(-1px); border-color:#64748b }
.btn:active{ transform:translateY(0) scale(.98) }
.btn.primary{ border-color:#2563eb; box-shadow:0 0 0 2px #1d4ed8 inset }
.btn.success{ border-color:#16a34a; box-shadow:0 0 0 2px #14532d inset }

/* Floating Admin */
.fab{ position:fixed; right:16px; bottom:calc(76px + env(safe-area-inset-bottom)); width:56px; height:56px; border-radius:16px; display:grid; place-items:center; border:2px solid #2b3546; background:linear-gradient(180deg,#0f172a,#0b1220); color:#93c5fd; box-shadow: var(--shadow); cursor:pointer; z-index:40; transition: transform .15s ease, border-color .2s ease; }
.fab:hover{ transform:translateY(-2px); border-color:#60a5fa }

/* Modal */
.modal{ position:fixed; inset:0; display:none; place-items:center; z-index:50; background:linear-gradient(180deg,#0009,#000c); }
.modal.active{ display:grid }
.panel{ width:min(920px, 96vw); max-height:92vh; overflow:auto; border-radius:22px; background:linear-gradient(180deg,#0a0f1bcc,#0b1220); border:1px solid var(--border); box-shadow: var(--shadow); padding:18px; }
.panel h2{ margin:0 0 10px 0 }
.grid{ display:grid; gap:10px; grid-template-columns: repeat(2, minmax(0,1fr)); }
@media (max-width:720px){ .grid{ grid-template-columns:1fr } }
.input,.textarea{ width:100%; padding:12px 12px; border-radius:12px; color:#e5e7eb; background:#0b1220; border:1px solid #253041; outline:none; }
.textarea{ min-height:160px; resize:vertical }
.switch{ display:flex; align-items:center; gap:10px; padding:10px; border:1px solid #253041; border-radius:12px; background:#0b1220; }
.small{ font-size:12px; color:#9ca3af }
.row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center }

/* Dashboard */
#dashboard{ display:none; }
.cards{ display:grid; gap:12px; grid-template-columns: repeat(2, minmax(0,1fr)); margin:12px 12px calc(112px + env(safe-area-inset-bottom)) 12px; }
@media(max-width:860px){ .cards{ grid-template-columns:1fr } }
.card h3{ margin:0 0 10px 0 }
.kpis{ display:grid; gap:10px; grid-template-columns: repeat(4, minmax(0,1fr)); }
@media(max-width:920px){ .kpis{ grid-template-columns: repeat(2, minmax(0,1fr)); } }
.kpi{ border:1px dashed #243041; border-radius:14px; padding:10px; text-align:center; background:#0b1220; }
.kpi .v{ font-size:22px; font-weight:900 }
.sep{ height:1px; background:#1f2937; margin:14px 0 }

/* Answers */
.answer{ border:1px solid #243041; border-radius:14px; padding:10px; margin-bottom:10px; background:#0b1220; }
.answer .status{ font-weight:800 }
.correct{ color:#22c55e } .wrong{ color:#ef4444 } .skipped{ color:#f59e0b }

/* Ripple */
.ripple{ position:absolute; border-radius:50%; pointer-events:none; transform:translate(-50%,-50%); animation:ripple .6s linear; background:#ffffff22; }
@keyframes ripple{ from{ width:0; height:0; opacity:.8 } to{ width:420px; height:420px; opacity:0 } }
.hidden{ display:none }
</style>
</head>
<body>
<div class="app" id="app">
  <!-- Header -->
  <header>
    <div class="header-row">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <h1 class="title" id="testName">Sample Test</h1>
      </div>
      <div class="row">
        <div id="timer" class="timer">00:00</div>
        <div class="stats">
          <div class="chip"><span class="dot dot-g"></span> Attended: <span id="attendedCount">0</span> (<span id="attendedMarks">0</span>)</div>
          <div class="chip"><span class="dot dot-r"></span> Unattended: <span id="unattendedCount">0</span> (<span id="unattendedMarks">0</span>)</div>
        </div>
      </div>
    </div>
    <div class="qnav-wrap"><div id="qnav" class="qnav"></div></div>
  </header>

  <!-- Main (scrollable) -->
  <main class="main">
    <section class="card" id="testPage">
      <div class="qhead">
        <div class="badge" id="qIndex">Q1</div>
        <p class="qtext" id="qText">Loading…</p>
      </div>
      <div class="qbody" id="options"></div>
    </section>

    <!-- Dashboard -->
    <section id="dashboard">
      <div class="cards">
        <div class="card">
          <h3>Score Summary</h3>
          <div class="kpis">
            <div class="kpi"><div class="small">Score</div><div class="v" id="kScore">0</div></div>
            <div class="kpi"><div class="small">Attended</div><div class="v" id="kAttended">0</div></div>
            <div class="kpi"><div class="small correct">Correct</div><div class="v" id="kCorrect">0</div></div>
            <div class="kpi"><div class="small wrong">Wrong</div><div class="v" id="kWrong">0</div></div>
          </div>
          <div class="sep"></div>
          <canvas id="scoreChart" height="210"></canvas>
        </div>
        <div class="card">
          <h3>Performance History</h3>
          <div class="small">हर टेस्ट के बाद ऑटो-रिकॉर्ड</div>
          <canvas id="historyChart" height="220"></canvas>
        </div>
        <div class="card" style="grid-column: 1/-1;">
          <h3>Detailed Answers</h3>
          <div id="answersList"></div>
        </div>
      </div>
    </section>
  </main>

  <!-- Bottom Fixed Nav -->
  <div class="bottom">
    <button id="prevBtn" class="btn" data-ripple>⟵ Previous</button>
    <button id="nextBtn" class="btn" data-ripple>Next ⟶</button>
    <button id="submitBtn" class="btn success" data-ripple>✅ Submit Test</button>
  </div>

  <!-- Admin FAB -->
  <button class="fab" id="openAdmin" title="Admin Panel (Ctrl+Shift+A)" data-ripple>⚙️</button>

  <!-- Admin Modal -->
  <div class="modal" id="adminModal" aria-hidden="true">
    <div class="panel">
      <div class="row" style="justify-content:space-between;">
        <h2>Admin Panel</h2>
        <div class="row">
          <button class="btn small" id="closeAdmin" data-ripple>Close</button>
          <button class="btn primary small" id="saveAdmin" data-ripple>💾 Save & Apply</button>
        </div>
      </div>
      <div class="small">सेटिंग्स localStorage में सेव होंगी और तुरंत लागू होंगी।</div>
      <div class="sep"></div>

      <div class="grid">
        <div>
          <label class="small">Test Name</label>
          <input id="aName" class="input" placeholder="e.g. Rajasthan GK Mock 01" />
        </div>
        <div>
          <label class="small">Timer (minutes)</label>
          <input id="aMinutes" type="number" min="1" class="input" />
        </div>
        <div>
          <label class="small">Total Questions</label>
          <input id="aCount" type="number" min="1" class="input" />
        </div>
        <div>
          <label class="small">Positive Mark (per correct)</label>
          <input id="aPositive" type="number" step="0.25" min="0" class="input" />
        </div>
        <div>
          <label class="small">Negative Marking (per wrong)</label>
          <input id="aNegative" type="number" step="0.25" min="0" class="input" />
        </div>
        <div>
          <label class="small">Red Alert (last N minutes)</label>
          <input id="aAlertMin" type="number" min="1" class="input" />
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <label class="switch"><input id="aAutoSubmit" type="checkbox" /> <span>⏱️ Time-out पर Auto Submit</span></label>
        <label class="switch"><input id="aResume" type="checkbox" /> <span>🔁 Reload पर Auto Resume</span></label>
      </div>

      <div class="sep"></div>
      <h3>Questions (JSON)</h3>
      <div class="small">Format: <code>[{"id":1,"text":"…?","options":["A","B","C","D"],"correct":0}]</code></div>
      <textarea id="aJSON" class="textarea" spellcheck="false"></textarea>
      <div class="row" style="margin-top:8px;">
        <input id="aFile" type="file" accept="application/json" class="input" />
        <button class="btn" id="btnImport" data-ripple>📥 Import JSON</button>
        <button class="btn" id="btnExport" data-ripple>📤 Export JSON</button>
        <button class="btn primary" id="btnGenerate" data-ripple>⚡ Auto-Generate Sample</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ---- Mobile dvh fix (stable viewport height) ---- */
function setDVH(){ document.documentElement.style.setProperty('--dvh', window.innerHeight + 'px'); }
setDVH(); window.addEventListener('resize', setDVH);

/* ---------- Storage Keys ---------- */
const KEY_SETTINGS = 'bt2_settings_v1';
const KEY_QUESTIONS = 'bt2_questions_v1';
const KEY_PROGRESS  = 'bt2_progress_v1';
const KEY_HISTORY   = 'bt2_history_v1';

/* ---------- Defaults ---------- */
const defaults = { name:'Sample Test', minutes:30, count:10, positive:1, negative:0.25, alertMinutes:5, autoSubmit:true, autoResume:true };

/* ---------- State ---------- */
let settings = loadSettings();
let questions = loadQuestions() || generateSample(settings.count);
let answers = new Array(questions.length).fill(-1);
let current = 0; let timeLeft = settings.minutes*60; let tRef=null; let charts={score:null,history:null};
let history = JSON.parse(localStorage.getItem(KEY_HISTORY) || '[]');

/* ---------- Utils ---------- */
function $(id){ return document.getElementById(id); }
function saveSettings(){ localStorage.setItem(KEY_SETTINGS, JSON.stringify(settings)); }
function loadSettings(){ try{ return {...defaults, ...(JSON.parse(localStorage.getItem(KEY_SETTINGS)||'{}'))}; }catch{ return {...defaults}; } }
function saveQuestions(){ localStorage.setItem(KEY_QUESTIONS, JSON.stringify(questions)); }
function loadQuestions(){ try{ const q=JSON.parse(localStorage.getItem(KEY_QUESTIONS)||'null'); return Array.isArray(q)&&q.length?q:null; }catch{ return null; } }
function saveProgress(){ localStorage.setItem(KEY_PROGRESS, JSON.stringify({answers,current,timeLeft,hash:hashS(settings)})); }
function loadProgress(){ try{ const p=JSON.parse(localStorage.getItem(KEY_PROGRESS)||'null'); return p&&p.hash===hashS(settings)?p:null; }catch{ return null; } }
function clearProgress(){ localStorage.removeItem(KEY_PROGRESS); }
function hashS(s){ return [s.name,s.minutes,s.count,s.positive,s.negative,s.alertMinutes,s.autoSubmit?1:0].join('|'); }
function clamp(v,min,max){ return Math.min(max, Math.max(min, v)); }
function fmt(n){ return (Math.round(n*100)/100).toString(); }

function generateSample(n=10){ const out=[]; for(let i=1;i<=n;i++){ out.push({ id:i, text:`Question ${i}: यह एक डेमो प्रश्न है?`, options:[`Option A of Q${i}`,`Option B of Q${i}`,`Option C of Q${i}`,`Option D of Q${i}`], correct:0 }); } return out; }

/* ---------- Ripple for buttons ---------- */
function attachRipple(root=document){ root.querySelectorAll('[data-ripple]').forEach(el=>{ el.addEventListener('click', e=>{ const r=document.createElement('span'); r.className='ripple'; const rect=el.getBoundingClientRect(); r.style.left=(e.clientX-rect.left)+'px'; r.style.top=(e.clientY-rect.top)+'px'; el.appendChild(r); setTimeout(()=>r.remove(),600); }); }); }
attachRipple();

/* ---------- Render ---------- */
function renderHeader(){ $('testName').textContent=settings.name; }
function renderTimer(){ const m=String(Math.floor(timeLeft/60)).padStart(2,'0'); const s=String(timeLeft%60).padStart(2,'0'); const el=$('timer'); el.textContent=`${m}:${s}`; el.classList.toggle('warn', timeLeft>0 && timeLeft<=settings.alertMinutes*60); }
function renderNav(){ const box=$('qnav'); box.innerHTML=''; questions.forEach((q,i)=>{ const b=document.createElement('button'); b.className='qnum ' + (answers[i]===-1?'unanswered':'answered') + (i===current?' current':''); b.textContent=q.id; b.onclick=()=>{ current=i; renderQuestion(); renderNav(); saveProgress(); }; box.appendChild(b); }); }
function renderStatus(){ const attended=answers.filter(a=>a!==-1).length; const unattended=questions.length-attended; $('attendedCount').textContent=attended; $('unattendedCount').textContent=unattended; $('attendedMarks').textContent=fmt(attended*settings.positive).replace(/\.00$/,''); $('unattendedMarks').textContent='0'; }
function renderQuestion(){ const q=questions[current]; $('qIndex').textContent=`Q${q.id}`; $('qText').textContent=q.text; const box=$('options'); box.innerHTML=''; q.options.forEach((opt,idx)=>{ const row=document.createElement('div'); row.className='opt'+(answers[current]===idx?' selected':''); row.setAttribute('data-ripple',''); row.innerHTML=`<div class="tag">${String.fromCharCode(65+idx)}</div><div class="opt-label">${opt}</div>`; row.onclick=(e)=>{ answers[current]=idx; renderNav(); renderStatus(); renderQuestion(); saveProgress(); }; box.appendChild(row); }); attachRipple(box); }

/* ---------- Timer ---------- */
function startTimer(){ if(tRef) clearInterval(tRef); renderTimer(); tRef=setInterval(()=>{ timeLeft=Math.max(0,timeLeft-1); renderTimer(); saveProgress(); if(timeLeft===0){ clearInterval(tRef); if(settings.autoSubmit) submitTest(); } },1000); }

/* ---------- Navigation ---------- */
$('prevBtn').onclick=()=>{ current=clamp(current-1,0,questions.length-1); renderQuestion(); renderNav(); saveProgress(); };
$('nextBtn').onclick=()=>{ current=clamp(current+1,0,questions.length-1); renderQuestion(); renderNav(); saveProgress(); };
$('submitBtn').onclick=()=> submitTest();

/* ---------- Submit / Dashboard ---------- */
function submitTest(){ clearInterval(tRef);
  let correct=0, wrong=0, skipped=0;
  questions.forEach((q,i)=>{ const a=answers[i]; if(a===-1) skipped++; else if(a===q.correct) correct++; else wrong++; });
  const score = correct*settings.positive - wrong*settings.negative;
  $('kScore').textContent=fmt(score); $('kAttended').textContent = correct+wrong; $('kCorrect').textContent=correct; $('kWrong').textContent=wrong;

  if(charts.score) charts.score.destroy();
  charts.score=new Chart($('scoreChart'),{ type:'doughnut', data:{ labels:['Correct','Wrong','Skipped'], datasets:[{ data:[correct,wrong,skipped] }] }, options:{ responsive:true, plugins:{ legend:{ labels:{ color:'#e5e7eb' } } } } });

  const rec={ date:new Date().toLocaleString(), score, correct, wrong, skipped, total:questions.length, positive:settings.positive, negative:settings.negative };
  history.push(rec); localStorage.setItem(KEY_HISTORY, JSON.stringify(history));

  if(charts.history) charts.history.destroy();
  charts.history=new Chart($('historyChart'),{ type:'line', data:{ labels:history.map(h=>h.date), datasets:[{ label:'Score', data:history.map(h=>h.score), tension:.35 }] }, options:{ responsive:true, plugins:{ legend:{ labels:{ color:'#e5e7eb' } } }, scales:{ x:{ ticks:{ color:'#9ca3af' }, grid:{ color:'#1f2937' } }, y:{ ticks:{ color:'#9ca3af' }, grid:{ color:'#1f2937' } } } } });

  const list=$('answersList'); list.innerHTML='';
  questions.forEach((q,i)=>{ const a=answers[i]; const status=(a===-1)?'Skipped':(a===q.correct?'Correct':'Wrong'); const cls=(a===-1)?'skipped':(a===q.correct?'correct':'wrong'); const div=document.createElement('div'); div.className='answer'; div.innerHTML=`<div class="status ${cls}">Q${q.id}: <span>${status}</span></div><div class="small" style="margin:6px 0 10px 0">${q.text}</div><div>✅ Correct Answer: <strong>${q.options[q.correct]}</strong></div><div>🧑‍💻 Your Answer: <strong>${a>-1?q.options[a]:'Skipped'}</strong></div>`; list.appendChild(div); });

  $('testPage').style.display='none'; $('dashboard').style.display='block'; clearProgress();
}

/* ---------- Admin Panel ---------- */
const adminModal=$('adminModal');
$('openAdmin').onclick=()=> openAdmin(); $('closeAdmin').onclick=()=> closeAdmin();
document.addEventListener('keydown',e=>{ if(e.ctrlKey&&e.shiftKey&&e.key.toLowerCase()==='a') openAdmin(); if(e.key==='Escape' && adminModal.classList.contains('active')) closeAdmin(); });
function openAdmin(){ fillAdmin(); adminModal.classList.add('active'); adminModal.setAttribute('aria-hidden','false'); }
function closeAdmin(){ adminModal.classList.remove('active'); adminModal.setAttribute('aria-hidden','true'); }
function fillAdmin(){ $('aName').value=settings.name; $('aMinutes').value=settings.minutes; $('aCount').value=settings.count; $('aPositive').value=settings.positive; $('aNegative').value=settings.negative; $('aAlertMin').value=settings.alertMinutes; $('aAutoSubmit').checked=settings.autoSubmit; $('aResume').checked=settings.autoResume; $('aJSON').value=JSON.stringify(questions,null,2); }

$('saveAdmin').onclick=()=>{
  settings.name=$('aName').value.trim()||defaults.name;
  settings.minutes=Math.max(1, parseInt($('aMinutes').value||defaults.minutes));
  settings.count=Math.max(1, parseInt($('aCount').value||defaults.count));
  settings.positive=Math.max(0, parseFloat($('aPositive').value||defaults.positive));
  settings.negative=Math.max(0, parseFloat($('aNegative').value||defaults.negative));
  settings.alertMinutes=Math.max(1, parseInt($('aAlertMin').value||defaults.alertMinutes));
  settings.autoSubmit=$('aAutoSubmit').checked; settings.autoResume=$('aResume').checked; saveSettings();

  try{ const data=JSON.parse($('aJSON').value||'[]'); if(!Array.isArray(data)||!data.length) throw 0; questions=data.slice(0,settings.count).map((q,i)=>({ id:q.id??(i+1), text:String(q.text??`Q${i+1}?`), options:(Array.isArray(q.options)&&q.options.length===4?q.options.map(String):['A','B','C','D']), correct:Number.isInteger(q.correct)?q.correct:0 })); }
  catch{ questions=generateSample(settings.count); }
  saveQuestions();

  current=0; answers=new Array(questions.length).fill(-1); timeLeft=settings.minutes*60; clearProgress();
  $('dashboard').style.display='none'; $('testPage').style.display='flex';
  renderHeader(); renderNav(); renderStatus(); renderQuestion(); renderTimer(); startTimer(); closeAdmin();
};

$('btnImport').onclick=()=>{ const f=$('aFile').files?.[0]; if(!f){ alert('Select a JSON file first.'); return; } const reader=new FileReader(); reader.onload=()=>{ $('aJSON').value=reader.result; }; reader.readAsText(f); };
$('btnExport').onclick=()=>{ const blob=new Blob([$('aJSON').value],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`${settings.name.replace(/\s+/g,'_')}_questions.json`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); };
$('btnGenerate').onclick=()=>{ const sample=generateSample(Math.max(1, parseInt($('aCount').value||settings.count))); $('aJSON').value=JSON.stringify(sample,null,2); };

/* ---------- Init ---------- */
function init(){
  renderHeader();
  let p = settings.autoResume ? loadProgress() : null;
  if(p){ answers=Array.isArray(p.answers)?p.answers:answers; current=clamp(p.current??0,0,questions.length-1); timeLeft=Math.max(1, p.timeLeft??(settings.minutes*60)); }
  else{ answers=new Array(questions.length).fill(-1); current=0; timeLeft=settings.minutes*60; }

  renderNav(); renderStatus(); renderQuestion(); renderTimer(); startTimer(); attachRipple();
}
init();

/* Prevent pinch-zoom causing layout jumps while keeping accessibility */
let lastTouchEnd=0; document.addEventListener('touchend', e=>{ const now=Date.now(); if(now-lastTouchEnd<=300){ e.preventDefault(); } lastTouchEnd=now; },{passive:false});
</script>
</body>
</html>
